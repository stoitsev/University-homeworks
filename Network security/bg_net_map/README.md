# Увод

Изграждане на Карта на Internet свързаността на България на трети слой е интересен проблем. Има две техники, които може да използваме, за да го решим. Първата проучва активно интернет, като изпраща пакети и анализира пътищата по които те пътуват. Този метод открива топологията базирайки се на съседство на маршрутизатори. Втората техника използва информация за автономните системи и връзките между тях, базирайки се на BGP данни. В настоящия реферат ще разгледаме примерна имплементация и на двата метода и една имплементация на инструмент за визуализиране на тези данни.

# Терминология

## Префикс

В настоящия документ ще използваме термина префикс. В текущия classless интернет, блок от клас A, B или C мрежа може да бъде рефериран като префикс и мрежова маска, стига блока да бъде ограничен по размер от число, степен на двойката. Например, мрежите:
  192.168.0.0/24
  192.168.1.0/24
  192.168.2.0/24
  192.168.3.0/24
могат да бъдат реферирани просто като:
  192.168.0.0/22
Термина префикс се използва тук като еквивалент на CIDR блок и може да бъде приет като група от една или повече мрежи. Термина мрежа се използва за указване на slassful мрежа или мрежа от клас A, B или C. 

## Автономни системи

[RIPE-109]
      Bates, T., Lord, A., "Autonomous System Number Application
      Form & Supporting Notes", RIPE 109, RIPE NCC, 1 March 1994.
      URL: ftp://ftp.ripe.net/ripe/docs/ripe-109.txt.
Автономна система е група от IP мрежи управлявани от един или няколко мрежови оператора, които имат общи и ясно дефинирани правила за маршрутизиране. Всяка една автономна система има уникален номер асоцииран с нея. Той се използва за обмяна на информация за маршрутизиране и за идентификатор на самата автономна система. Протоколи за външна маршрутизация като BGP и EGP се използват за обмяна на маршрутизираща информация между автономните системи.

В термините на вътрешното маршрутизиране, една автономна система нормално използва един или няколко протокола за обмяна на маршрутизираща информация между маршрутизаторите вътре в рамките на автономната система.

Често, автономните системи се използват неправилно като начин за групиране на набор от мрежи, които са под управление на една и съща организация, но използват различно вътрешно маршрутизиране. В стандартите е дефинирано, че една автономна система може да има единствена вътрешна маршрутизираща схема.

On the other hand, the creation of an AS should be done in a
conscious and well coordinated manner to avoid creating ASes
for the sake of it, perhaps  resulting  in  the  worst  case
scenario of one AS per IP network number. This may mean that
by applying the general rules for the creation  and  alloca-
tion of an AS below, some re-engineering may be needed. How-
ever, this may be the  only  way  to  actually  implement  a
desired routing policy anyway.

[RFC 1930 - Guidelines for creation, selection, and registration of an Autonomous System (AS)]
ASes are the
unit of routing policy in the modern world of exterior routing, and
are specifically applicable to protocols like EGP (Exterior Gateway
Protocol, now at historical status; see [EGP]), BGP (Border Gateway
Protocol, the current de facto standard for inter-AS routing; see
[BGP-4]), and IDRP (The OSI Inter-Domain Routing Protocol, which the
Internet is expected to adopt when BGP becomes obsolete; see [IDRP]).

An AS must be used for exchanging external routing information
with other ASes through an exterior routing protocol. The cur-
rent recommended exterior routing protocol is BGP, the Border
Gateway Protocol. However, the exchange of external routing
information alone does not constitute the need for an AS. See
"Sample Cases" below.

Тhe use of the
  term Autonomous System here stresses the fact that, even when
  multiple IGPs and metrics are used, the administration of an AS
  appears to other ASes to have a single coherent interior routing
  plan and presents a consistent picture of what networks are
  reachable through it.

## BGP

http://tools.ietf.org/html/rfc4271

Border Gateway Protocol (BGP) е протокол за маршрутизиране между автономни системи. Главната функция на една BGP система е да обменя информация за достижимостта до други BGP системи. Тази информация включа в себе си списък на автономните системи за които има данни за достижимост. Тази информация е достатъчна за построяване на граф на връзките между автономните системи, в които няма маршрутизиращи цикли и в които могат да се сложат различни правила на ниво автономна система.

Последната версия на BGP протокола е 4. Тя предоставя набор от механизми за поддръжка на Classless Inter-Domain Routing (CIDR) [RFC1518, RFC1519]. Тези механизми включват способност за обмен на информация за набор от дестинации под формата на IP префикси и елиминира концепцията за клас в BGP. В BGP-4 също се поддържат механизми за агрегиране на маршрути.

Маршрутизиращата информация обменяна през BGP поддържа само парадигма базирана на дестинация. Тя предполага, че маршрутизаторите изпращат пакети, базирайки се само на адреса на дестинацията, пренасян в заглавната им част.

## Структура на регистрите на номера

[RFC-7020]
Йерархията на регистрите на имена(Internet Registry hierarchy) е била установена за да се улесни раздаването на IP адреси и номера на автономни системи. Корена на йерархията е организацията Internet Assigned Numbers Authority (IANA). Тази организация управлява множество от регионални организации - Regional Internet Registries (RIRs). От своя страна, те управляват локални организации - Local Internet Registries (LIRs). Това са организациите, които работят с крайните клиенти.

За да може да се раздели работата по управлянието на IP адресите и номерата на автономните системи, RFC 1366, за първи път, предлага правила за разпределяне на тези права между регионални организации. Тези организации биват именовани като регионални интернет регистри - Regional Internet Registries (RIRs). Те работят в рамките на даден континент. В момента има 5 подобни организации: AfriNIC, обслужваща Африка, APNIC, обслужваща части от Азия и тихоокеанския регион, LACNIC, обслужваща Латинска Америка и част от Карибите, RIPE NCC, обслужваща Европа, части от Азия и Близкия Изток. 

# Подходи за събиране на информация

Има два начина за събиране на информация, на база на която да бъде изградена карта на свързаността на България на трето ниво - активно проучване и проучване базирано на BGP данни. 

## Активно проучване

Тази техника разчита на traceroute подобно проучване на IP адресното пространство. Когато стартираме процес по откриване на маршрута до даден адрес, откриваме междинните устройства по пътя до него. При комбиниране на информацията за междинните устройства по различни маршрути вътре в мрежата, може да се предположи маршрутизиращата топология.

Метода на активното проучване, предполага че намерените пътища представляват реалните пътища по които минават пакетите, което не винаги е вярно. Въпреки това, това е удобен начин да се открият устройствата свързващи различни интернет доставчици. За да може да се постигне разширена карта с този метод, трябва да бъдат изпратени пакети до голямо количество адреси. Ако се прекали с количеството пакети, може да се получат фалшиви данни, поради наличието на устройства балансиращи натоварването и маршрутизатори с няколко адреса. Поради факта, че вече не се поддържат механизми като ICMP Echo Broadcasting, този тип проучване не е много ефективен.

## Проучване базирано на BGP данни

Тази техника разчита на различни BGP източници на информация, които събират маршрутизиращи съобщения и таблици и предоставят тази информация публично. Всеки BGP запис съдържа маршрутен вектор(Path Vector) с атрибути и се нарича път до автономна система(AS Path). Този път представя автономната система, която препраща пакетите към определен набор от префикси. Тези маршрути могат да се използват за да се установи какъв е типа на връзката между автономните системи. По този начин може да се построи топологичен граф на автономните системи. Понякога, тези маршрути не представляват как реално се транспортират пакетите и съседство между две автономни системи представлява само логическа връзка между двете. Реално, една връзка между автономни системи може да се осъществява през няколко маршрутизатора. Също така, е трудно да се събере информация за съседството между автономните системи, защото тази информация се обявява само в рамките на самите автономни системи. Въпреки това, съществува поддръжка на публични регистри с тази информация, като тези на RIPE, които използваме в настоящия проект.

# Автоматизиране на събирането на данни

За изграждане на карта на свързаността на трети слой в България ще използваме метода с проучване базирано на BGP данни. При него се изискват по-малко ресурси и лесно може да се окаже по-ефективен. За набавяне на тази информация ще използваме публичните данни предоставени от регионалния RIR за Европа - Réseaux IP Européens Network Coordination Centre (RIPE NCC). Тя управлява разпределянето на IPv4 и IPv6 адреси и номера на автономните системи на територията на континента. 
Една от ключовите дейности на RIPE NCC е да поддържа база от данни с името RIPE Database. В нея се съхранява регистрационна информация на IP адресите и автономните системи алокирани от организацията. Тази информация се състой от данни за ресурса, къде е алокиран и кое е лицето за контакт с притежателя на дадения ресурс. Организациите, които притежават тези ресурси са отговорни за обновяване на информацията в база от данни. Тази база от данни може да бъде достъпена от Web интерфейс или директно чрез whois клиент на whois.ripe.net.  
Друга част от тази база от данни съдържа маршрутизираща информация, съхранена във формата Routing Policy Specification Language(RPSL). Тези данни са огледални на маршрутизиращата информация за интернет и двете бази от данни обменят данни постоянно. Третото нещо, което се съхранява в RIPE Database е домейн имена. Те служат само за референция. Организацията не се грижи за поддържане на регистър с домейните.
Друг полезен ресурс, които се предоставя от RIPE NCC, са файлове със статистика. Това са текстови файлове, съдържащи данни, записани във формата RIR Statistics Exchange Format и могат да бъдат намерени на адрес ftp://ftp.ripe.net/pub/stats/ripencc/. Файловете съдържат статистика, обобщаваща текущото състояние на алокираните и раздадените ресурси, като IP адреси и номера на автономни системи. Тяхната идея е да предоставят бърз поглед върху тези ресурси, без транзакционната и историческа информация за тях. В хранилището с тези данни се съдържат версии от 2003 година до сега, като има отделни документи съдържащи най-актуални данни. За целите на проекта ще използваме най-актуалния набор от данни. Тези текстови файлове се генерират ежедневно в 23:59:59, като съдържат всички алокирани и раздадени номера до съответната дата. Освен самите текстови файлове се предоставя и md5 сума за верификация на интегритета на данните.

Имената на файловете са във формат delegated-<registry>-yyyymmdd, където registry е едно от apnic,arin,iana,lacnic или ripencc, а последната част от името на файла е датата на неговото създаване. Във файла delegated-<registry>-latest се съдържат последните данни за алокираните ресурси. Съдържанието на файловете представлява коментари, заглавен ред и записи, които са по един на ред. Заглавния ред и записите са структурирани като данни разделени със запетая(comma separated fields). Вертикалната права черта '|' (ASCII код 0x7c) се използва като CSV разделител. След заглавния ред, записите не са сортирани. Всеки запис представлява един алокиран или раздаден ресурс, представляващ IP адрес или номер на автономна система. Формата на данните е следния:

registry|cc|type|start|value|date|status[|extensions...]

registry - Едно от apnic,arin,iana,lacnic или ripencc. Представлява организацията регистрирала ресурса.

cc - ISO 3166 двубуквен код на държавата. Това поле идентифицира държавата. Това не означава точно държавата, в която се използва ресурса, а държавата в която притежателя на ресурса оперира.

type - Тип на ресурса. Един от следните - asn,ipv4 или ipv6.

start - В случай, че типа е ipv4 или ipv6 това поле съдържа първия адрес в префикса. В случай, че типа е asn, то полето съдържа 16 битов номер на автономната система. Това е число между 0 и 65535. В случай, че описва 32 битов номер на автономна система, е число от 0 до 4294967296. 

value - В случай, че типа е ipv4 съдържа броя крайни адреси в префикса. Не е задължително да съдържа CIDR диапазона. В случай, че типа е ipv6, това поле съдържа дължината на префикса от първия адрес в мрежата, описан в start полето. В случай, че типа е asn е броя автономни системи, започващи от номера записан в start.

date - Деня на алокиране или раздаване. Записано е във формат YYYYMMDD. Ако ресурс е бил прехвърлен от друг регистър, то тази дата съдържа датата на прехвърляне.

статус - Има една от двете стойности - allocated или assigned.

extensions - Допълнителна информация за ресурс.

От тези документи може да бъде взета информация за всички автономни системи, регистрирани от български фирми. За целта трябва да филтрираме всички записи, които имат BG, като стойност за cc и asn, като стойност за type. При прочитане на start може да намерим номерата на автономните системи, отговарящи на предишните две условия. Резултатния списък ще съдържа само номерата без допълнителна информация.

За да съберем допълнителна информация за всеки номер на автономна система, изпозлва whois услугата, предоставена от RIPE NNC. При изпълняване на следната команда:

whois -h riswhois.ripe.net 5421

Получаваме следния отговор от сървъра:

route:        62.44.96.0/19
origin:       AS5421
descr:        SU-NET-AS Sofia University "St. Kliment Ohridski"
lastupd-frst: 2013-12-03 09:59Z  195.69.144.110@rrc03
lastupd-last: 2014-01-29 23:35Z  193.232.244.245@rrc13
seen-at:      rrc00,rrc01,rrc03,rrc04,rrc05,rrc06,rrc07,rrc10,rrc11,rrc12,rrc13,rrc14,rrc15
num-rispeers: 111
source:       RISWHOIS

От тук може да извлечем името на автономната система и други допълнителни данни. За целите на настоящия проект, ще използваме само името записано в полето descr. След като комбинираме номера на автономната система с нейното име, получаваме структура от данни, съдържаща номера и името на всяка автономна система, регистирана от българска компания.

Последното парче липсваща информация е за връзката между автономните системи. Тя може да бъде набавена от Web услугите даващи достъп до база от данни на RIPE. Те могат да се достъпят на адрес http://stat.ripe.net/data. Те използват REST архитектура и обменят данни чрез JSON. Услугата която ни интересува е достъпна на адрес http://stat.ripe.net/data/asn-neighbours/data.json, като се добавя и един GET параметър указващ номера на автономната система, чиито съседи искаме да получим. Ключа се този параметър е именован resource. Една примерна заявка е:

http://stat.ripe.net/data/asn-neighbours/data.json?resource=5421

Като отговора, който получаваме е:

{
    ...
    "data": {
        "neighbour_counts": {
            "left": 2, 
            "right": 0, 
            "uncertain": 0, 
            "unique": 2
        }, 
        "neighbours": [
            {
                "asn": 6802, 
                "power": 194, 
                "type": "left", 
                "v4_peers": 420, 
                "v6_peers": 27
            }, 
            {
                "asn": 8717, 
                "power": 94, 
                "type": "left", 
                "v4_peers": 44, 
                "v6_peers": 186
            }
        ], 
        "query_endtime": "2014-01-29T16:00:00", 
        "query_starttime": "2014-01-29T16:00:00", 
        "resource": "5421"
    }, 
    ...
}

Интересната информация е в полето data. То представлява обект, в който се съдържа поле neighbours, което представлява масив със съседните автономни системи. За всяка от тях получаваме номер, записан в asn и допълнителна информация. За целите на проекта ще използваме само номерата на съседните мрежи. След като имаме списък с автономните системи, регистирани от български фирми и връзките между тях, имаме цялата информация, необходима за построяване на карта на свързаността в България на трето ниво.

## Имплементация

Неразделна част от проект е програмната му реализация. Тя е написана на езика за програмиране Ruby, като е използвана последната версия 2.1.0. Приложението използва стандартна структура за Ruby проект. Има директория data, в която се записва информацията извлечена на дадена стъпка. В lib се намира кода на приложението. Всяка стъпка от процеса по изграждане на картата е в отделен файл, за да може да се изпълнява индивидуално. В spec се съдържат автоматизираните тестове на приложението. Директорията visualization съдържа частта, отговорна за визуализиране на самата карта, която е имплементирана на JavaScript. В проекта се използват няколко разширения за Ruby, описани във файла Gemfile. Първото е pmap, което служи за паралелно изпълнение на задачи. Второто е Rake и представлява build системата, подобна на Make. Файла Rakefile служи за конфигуриране на тази система и съдържа описание на командите, стартиращи отделните стъпки в процеса.

Първата стъпка е имплементирана във файла lib/scraper.rb. Тя може да се стартира с изпълнение на кратката команда rake scrap в главната директория на приложението. Разделена е на две части. В първата част от стъпката, се сваля файла с най-актуалните данни за алокираните и раздадените ресурси от RIPE. Това става с помощта на wget, което е свободен инструмент за сваляне на файлове от мрежата. Извикването на самата команда става по следния начин:

wget -O data/delegated_numbers.csv ftp://ftp.ripe.net/pub/stats/ripencc/delegated-ripencc-latest

В случая използваме параметъра -O, който указва на wget да запише сваления файл под съответното име - delegated_numbers.csv. Към името на файла добавяме разширението csv за да е известно, че данните записани вътре следват CSV формата. След сваляне на файла, се преминава към втората част. Тя включва парсване на файла и филтриране на номерата на автономните системи регистрирани от български фирми. За прочитане на CSV файла се използва CSV модула от стандартната библиотека на Ruby. В него се съдържа метода read, който приема име на файл и конфигурационни параметри, като например разделителя. Понеже в CSV файла се използва права черта за разделител на атрибутите, това трябва да бъде специално указано в конфигурацията на read, защото по подразбиране се очаква, че разделителя е запетая. Като резултат от извикване на метода се получава масив от масиви, всеки от който представлява един запис от файла, в който атрибутите са подредени позиционно като елементи на масива. За итериране през този масив се използва метода select от модула Enumerable. Той служи за филтриране на елементи и се извиква с итератор, който оценява дали елемента да бъде включен в резултатната колекция или не. Булевото условие, което е зададено в итератора очаква втория елемент на масива да бъде BG и третия елемент на масива да бъде asn. По този начин филтрираме всички записи от CSV файла, който отговарят на автономни системи, регистрирани от български фирми. 
След филтрирането използваме метода map, който приема итератор и го прилага на всеки елемент от колекцията. В случая, подадения итератор заменя целия масив с третия елемент от него, който представлява самия номер на автономна система. Така получаваме масив от низове с номерата на автономните системи. Резултата се записва в JSON формат и се кешира във файл записан в data/cache/bg_numbers.json.

Втората стъпка по изграждане на картата е обогатяване на данните за автономните системи. Това става с използване на whois клиент, насочен към whois сървъра на RIPE. За целта се прочита кеширания файл, който получаваме като резултата от първата стъпка и се изпълнява whois заявка за всеки елемент посочен там. Заявките се изпълняват паралелно с помощта на pmap разширението към Ruby, за увеличаване на бързодействието. Всяка заявка се пуска в отделна нишка и резултата се обединява накрая. Във всяка нишка се прави whois извикване, след което се обработва получения отговор и с помощта на регулярни изрази се извлича информация за името на автономната система, префикса асоцииран с нея и оригиналното име. Резултата от тази стъпка се кешира и се записва във файла data/cache/bg_asns.json.

Третата стъпка е извличането на информация за връзките между автономните системи. В нея, за всяка една автономна система се стартира отделна нишка, в която се изпълнява заявка към отдалечената услуга на RIPE, която връща информация за съседните автономни системи. За изпращане на заявките се използва Net модула от стандартната библиотека на Ruby и pamp за паралелно изпълнение на задачите. При получаване на отговор, се проверява статуса му и се обработва тялото на отговора, за да се извлече само информацията за съседните автономни системи. Отдалечената услуга се достъпва на следния URL:

http://stat.ripe.net/data/asn-neighbours/data.json?resource=#{asn}

В този адрес, се интерполира параметъра asn със съответния номер на автономната система, за която се изпълнява заявката. Отговора е записан в JSON формат, което го прави изключително лесно за обработка. Като резултат от стъпка се получава масив, представляващ списък на съседите. Това е структура от данни за описване на графи, която е имплементирана като речник, ключовете на които са номера на автономни системи, а стойностите са списъци с автономните системи, които са съседни на нея. Резултата от тази стъпка се кешира и се записва в JSON формат във файла data/cache/bg_asns.json.

Последната стъпка по изграждане на картата е съставянето на структурата от данни, която се използва от визуализиращата част на приложението. Тази структура от данни съдържа списък на ребрата на графа описващ връзките между автономните системи. В началото процеса започва с празен масив. Алгоритъма итерира списъка на съседите, генериран на предишната стъпка. На всяка итерация се итерират съседите за всеки връх и се добавят нови записи в масива, които представляват ребрата започващи от съответния връх и свършващи в съответния съсед. При тази операция се добавят само ребра, на които и двата края са върхове, описващи автономни системи, регистрирани от български фирми. Това се прави с цел да се намали графа, за да е възможно неговото визуализиране. Като резултат от операцията се получва структура от данни, която описва 1570 връзки между 471 автономни системи. Резултата от тази стъпка се кешира и се записва в JSON формат във файла visualization/links.json.

# Визуализиране на информацията

Важна част от проекта е визуализирането на самата карта. То се извършва с HTML5 решение, което разчита на рисуване на картата под формата на граф в браузър с помощта на Scalable Vector Graphics(SVG). Причината за този избор, е че по този начин картата ще бъде свободно достъпна и лесна за разпространение. Тя може да бъде намерена на адрес:

http://stoitsev.com/fmi/netsec/prj

За да може, картата да се достъпва локално като част от приложението, се стартира малък сървър, който да предоставя статичните файлове използвани за визуализирането. Това става с помощта на модула Webrick от стандартната библиотека на Ruby. Файла за стартиране на сървъра се намира в visualization/server.rb и съдържа извикване към Webrick. Може да се стартира и чрез build командата rake server. След като се стартира сървъра, той започва да слуша за заявки на порт 8000. Ако отворим браузър и заредим http://localhost:8000 ще заредим визуализацията на картата. Причината, да има необходимост от използване на сървър, е че за зареждане на файла със списъка на ребрата, се изпраща асинхронна заявка посредством XMLHttpRequest. Ако отворим файла index.html по стандартен начин през браузъра, той ще бъде достъпен през file протокола. Ако се опитаме да изпълним асинхронна заявка в този момент, ще нарушим Same-origin policy на браузъра и самата заявка ще бъде прекратена. Ако заредим файла през http протокола и се опитаме да достъпим json файла на същия адрес, няма да нарушим Same-origin policy и файла ще бъде зареден.

Рисуването на графа се извършва с помощта на библиотеката D3.js. Тя е реализирана на езика за програмиране JavaScript и главната и цел е да позволи манипулирането на документи базирани на данни. D3 помага за изграждането на интерактивни визуализации използвайки HTML, SVG и CSS. Тя набляга на използване на модерни уеб стандарти, които са съвместими с повечето модерни браузъри. Библиотеката комбинира мощни компоненти за визуализиране и подход базиран на данни за манипулиране на DOM дървото.

Заключение

Резултата от проекта е интерактивна карта на Internet свързаността на България на Layer 3, достъпна публично в интернет. Тя използва най-актуалните данни и дава реална представа за топологията на мрежата. Информацията в нея може лесно да бъде обновявана, подари наличието на автоматизирани инструменти за нейното извличане и обработване, които са оптимизирани откъм скорост, чрез разпаралеляване на тяхната работа. Финалния продукт е използваем и информативен.

Адрес на картата:

http://stoitsev.com/fmi/netsec/prj/

Най-актуална версия на софтуера:

https://github.com/stoitsev/bg_net_map

